<!DOCTYPE html>
<html lang='en'>
   <head>
      <meta charset='UTF-8'>
      <title>drag-js</title>
   </head>
   <body>
    <div id='root'></div>
    <script type='text/javascript'>
    createButton = (buttonName, handler) => {
      const button = document.createElement('button');
      button.innerHTML = buttonName;
      button.value = buttonName;
      button.style.height = '30px';
      button.addEventListener('click', handler);
      return button;
    }
    createAddButton = () => {
      return createButton('CREATE', () => addHandler());
    }
    createCloseButton = () => {
      return createButton('CLOSE', () => closeHandler());
    }
    createRemoveButoon = () => {
      return createButton('REMOVE', () => removeHandler());
    }
    grandParent = (el) => {return el.parentNode.parentNode}
    getName = (name) => {
      const nameRoot = name.slice(0,name.length-1);
      let i = name[name.length-1];
      name = `${nameRoot}${++i}`;
      return name;
    }
    createInput = (inputId) => {
      const input = document.createElement('INPUT');
      input.id = `inp${inputId}`;
      input.setAttribute('type', 'checkbox');
      input.addEventListener('change', () => checkButtonsState());
      return input;
    }
    createBranch = (name) => {
      const id = new Date().valueOf();
      const li = document.createElement('li');
      li.id = `li${id}`;
      li.title = name;
      li.value = 0;
      const div = document.createElement('div');
      div.id = `div${id}`;
      div.value = 1;
      const li_name = document.createElement('h2');
      li_name.innerHTML = name;
      div.appendChild(li_name);
      const input = createInput(id);
      input.style.cssFloat = 'left';
      div.appendChild(input);
      const address = document.createElement('h2');
      address.innerHTML = (`|___ id = ${li.id}`);
      address.value = 3;
      address.style.color = `rgb(${parseInt(Math.random()*300)}, 0, ${parseInt(Math.random()*200)})`;
      div.appendChild(address);
      div.style.border = '2px solid rgb(304, 0, 318)';
      li.appendChild(div);
      //drag and drop//
      li.style.border = '2px solid rgb(104, 0, 18)';
      li.style.margin = '10px';
      li.style.padding = '10px';
      li.draggable = true;
      li.addEventListener('dragstart', (evt) => dragstartHandler(evt));
      address.addEventListener('drop', (event) => dropHandler_li(event, li.id ));
      return li;
    }
    setNames = () => {
      const ulNodes = document.getElementsByTagName('UL');
      const rootName = 'Tree';
      for(let i = 0; i < ulNodes.length; ++i){
        if (i === 0) {
          ulNodes[i].title = rootName;
        } else ulNodes[i].title = ulNodes[i-1].title+0;
        console.log('ulNodes[i].title', ulNodes[i].title);
        let ul_arr = ulNodes[i].childNodes;
        let ulTitle = ulNodes[i].title;
        let j = 0;
        while(j < ul_arr.length){
          let li = ul_arr[j];
          li.title = ulTitle + j;
          let div = li.firstChild;
          div.firstChild.innerHTML = li.title;
          ++j;
        }
      }
    }
    createUl = (name) => {
      const id = new Date().valueOf();
      let ul = document.createElement('ul');
      ul.value = 'dropTargetUl';
      ul.id = `Ul${id}`;
      ul.title = `${name}`;
      //drag and drop//
      ul.style.border = '2px solid rgb(204, 0, 108)';
      ul.style.padding = '15px';
      ul.style.margin = '15px';
      ul.addEventListener('drop', (event) => dropHandler_Ul(event, ul.id ));
      ul.addEventListener('dragover', (event) => dragoverHandler(event));
      ul.addEventListener('dragenter', (event) => dragenterHandler(event));
      ul.addEventListener('dragleave', (event) => event.target.style.backgroundColor = 'initial');
      return ul;
    }
    checkButtonsState = () => {
      const inputArr = document.querySelectorAll('input:checked');
      const close_button = document.querySelector('button[value = "CLOSE"]');
      const remove_button = document.querySelector('button[value = "REMOVE"]');
      if(!inputArr.length) {
        close_button.disabled = true;
        remove_button.disabled = true;
      } else {
        remove_button.disabled = false;
        for(inp of inputArr){
          if(grandParent(inp).childElementCount < 2){
            close_button.disabled = true;
            break;
          } else close_button.disabled = false;
        }
      }
    }
    addHandler = () => {
      const rootName = 'Tree';
      const input_arr = document.querySelectorAll('input:checked');
      const parent = event.target.parentNode;
      let ul = parent.nextSibling;

      if(!ul) {
        let ulBranch = createUl(rootName);
        ulBranch.appendChild(createBranch(ulBranch.title+0));
        parent.parentNode.appendChild(ulBranch);
      } else if(input_arr.length) {
          for(inp of input_arr) {
            let title = grandParent(inp).title;
            if(!inp.parentNode.nextSibling){
              let ulBranch1 = createUl(title);
              ulBranch1.appendChild(createBranch(title+0))
              grandParent(inp).appendChild(ulBranch1);
            } else {
              let subUl = inp.parentNode.nextSibling;
              const liTitle = subUl.lastChild.title;
              subUl.appendChild(createBranch(getName(liTitle)));
            }
          }
      } else {
        const nextTitle = ul.lastChild.title;
        ul.appendChild(createBranch(getName(nextTitle)));
      }
      checkButtonsState();
    }
    closeHandler = () => {
      const input_arr = document.querySelectorAll('input:checked');
      const close_button = document.querySelector('button[value = "CLOSE"]');
      if(close_button.innerHTML =='CLOSE'){
        close_button.innerHTML = 'OPEN';
        for (inp of input_arr){
          let ul = inp.parentNode.nextSibling;
          inp.nextSibling.style.visibility = 'hidden';
          ul.style.display = 'none';
        }
      } else {
        close_button.innerHTML = 'CLOSE';
        for (inp of input_arr){
          let ul = inp.parentNode.nextSibling;
          inp.nextSibling.style.visibility = 'visible';
          ul.style.display = 'block';
        }
      }
    }
    removeHandler = () => {
      const input_arr = document.querySelectorAll('input:checked');
      for(inp of input_arr) {
        if(grandParent(inp).parentNode.childElementCount > 1)
          grandParent(inp).remove();
        else grandParent(inp).parentNode.remove();
      }
      const close_button = document.querySelector('button[value = "CLOSE"]');
      close_button.innerHTML = 'CLOSE';
      checkButtonsState();
    }
    createHeader = () => {
      const header = document.createElement('div');
      const addButton = createAddButton();
      header.appendChild(addButton);
      const closeButton = createCloseButton();
      closeButton.disabled = true;
      header.appendChild(closeButton);
      const removeButton = createRemoveButoon();
      removeButton.disabled = true;
      header.appendChild(removeButton);
      header.style.margin = '30px';
      return header;
    }
    const container = document.getElementById('root');
    const header = createHeader();
    container.appendChild(header);
    /////////////////////////////////////////////////
    //drag and drop//
    const info = document.createElement('div');
    header.appendChild(info);
    info.style.display = 'flex';
    //info.style.flexDirection = 'column';
    info.style.flexWrap = 'wrap';
    createInfo = (title) => {
      const input = document.createElement('INPUT');
      input.setAttribute('type', 'text');
      const p = document.createElement('p');
      p.innerHTML = title;
      p.style.margin = '5px';
      input.style.width = '400px';
      p.appendChild(input);
      input.style.margin = '1px';
      info.appendChild(input.parentNode);
      return input;
    }
    const input1 = createInfo(' coords');
    document.onmousemove = () => {
      input1.setAttribute("value",showCoords(event))
    }
    input1.style.width = '120px';
    const input2 = createInfo(' dragover');
    const input3 = createInfo(' drop on Ul');
    const input3_ = createInfo(' drop on li');
    const input4 = createInfo(' drag start');
    const input5 = createInfo(' onMouseDown');
    document.onmousedown = () => {
      input5.setAttribute("value",`${event.target}, ${event.target.id}`);
    }
    showCoords = (ev) => {
        let x = ev.clientX, y = ev.clientY;
        let coords = "X: " + x + ", Y: " + y;
        return coords;
    }
    const dragElement = (ev) => {
      const moveItemIndex = ev.dataTransfer.getData("text");
      const moveItem =  document.getElementById(moveItemIndex);
      return moveItem;
    }
    getNearElIndex = (ev) => {
      const children = ev.target.childNodes;
      const el = children[0];
      let index = children.length-1;
      const last_Y = ev.clientY;
      const initial_Y = dragElement(ev).getBoundingClientRect().top;
      for(let i = 0; i < children.length; ++i){
        const target_Y = children[i].getBoundingClientRect().top;
        const dist = target_Y - last_Y;
        const direction = last_Y - initial_Y;
        if(dist > 0) {
          if(direction < 0)//moving up
            index = i;
          else index = --i; //moving down
          break;
        }
      }
      return index;
    }
    removable = (drag_el) => {
      if(!drag_el.nextSibling && !drag_el.previousSibling
        && (grandParent(drag_el).parentNode.tagName === 'UL')
        && (parent !== drag_el.parentNode)){
          return true;
        } else return false;
    }
    dropHandler_Ul = (ev, location) => {
      const parent = ev.target;
      const drag_el = dragElement(ev);
      if (location !== parent.id) return;
      const ul_arr = [];
      let children = parent.childNodes;
      const index = getNearElIndex(ev);
      for (let i = 0; i < children.length; ++i){
        if(children[i] !== drag_el)
        ul_arr.push(children[i]);
      }
      if(removable(drag_el)) drag_el.parentNode.remove();
      ul_arr.splice(index,0,drag_el);
      while(parent.firstChild) {
        parent.firstChild.remove();
      }
      let i = 0;
      while(ul_arr[i]) {
        parent.appendChild(ul_arr[i++]);
      }
      setNames();
      parent.style.backgroundColor = 'initial';
      input3.setAttribute("value",`${showCoords(ev)}, target=${ev.target.id}, data=${drag_el.id}`);
      ev.preventDefault();
    };

    dropHandler_li = (ev, value) => {
      const drag_el = dragElement(ev);
      const parent_li = grandParent(ev.target);
      if (parent_li.firstChild.nextSibling || drag_el.contains(ev.target)){
        ev.target.style.backgroundColor = 'initial';
        return;
      } 
      let address = drag_el.firstChild.firstChild;
      let title = parent_li.title;
      let ulBranch = createUl(title);
      address.innerHTML = ulBranch.title+0;
      if(removable(drag_el)) drag_el.parentNode.remove();
      ulBranch.appendChild(drag_el);
      drag_el.title = ulBranch.title+0;
      parent_li.appendChild(ulBranch);
      ev.target.style.backgroundColor = 'initial';
      setNames();
      ev.preventDefault();
    };
    dragoverHandler = (ev) => {
      let d = '';
      if(ev.target.value === 'dropTargetUl' || ev.target.value === 3) {
        d = ev.target.value;
        ev.preventDefault();
      } else d = 'no drop';
      input2.setAttribute("value",`${showCoords(ev)}, ${ev.target.id}, value:${d}`);
    };
    dragstartHandler = (ev) => {
      ev.dataTransfer.setData("text", ev.target.id);
      input4.setAttribute("value",`${showCoords(ev)}, ${ev.target.id}`);
    };
    dragenterHandler = (ev) => {
      if (ev.target.value === 'dropTargetUl')
        ev.target.style.backgroundColor = 'hsla(328, 92%, 88%, 0.72)';
      if (ev.target.value === 3)
        ev.target.style.backgroundColor = 'hsla(157, 68%, 59%, 0.58)';
    }

    </script>
  </body>
</html>
