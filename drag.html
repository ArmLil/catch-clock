<!DOCTYPE html>
<html lang='en'>
   <head>
      <meta charset='UTF-8'>
      <title>drag-js</title>
   </head>
   <body>
    <div id='root'></div>
    <script type='text/javascript'>
    createButton = (buttonName, handler) => {
      const button = document.createElement('button');
      button.innerHTML = buttonName;
      button.value = buttonName;
      button.style.height = '30px';
      button.addEventListener('click', handler);
      return button;
    }
    createAddButton = () => {
      return createButton('CREATE', () => addHandler());
    }
    createCloseButton = () => {
      return createButton('CLOSE', () => closeHandler());
    }
    createRemoveButoon = () => {
      return createButton('REMOVE', () => removeHandler());
    }
    getName = (name) => {
      const nameRoot = name.slice(0,name.length-1);
      let i = name[name.length-1];
      name = `${nameRoot}${++i}`;
      return name;
    }
    createInput = (inputId) => {
      const input = document.createElement('INPUT');
      input.id = `inp${inputId}`;
      input.setAttribute('type', 'checkbox');
      input.addEventListener('change', () => checkButtonsState());
      return input;
    }
    createBranch = (name) => {
      const id = new Date().valueOf();
      const li = document.createElement('li');
      li.id = `li${id}`;
      li.title = name;
      const div = document.createElement('div');
      div.id = `div${id}`;
      const li_name = document.createElement('h3');
      li_name.innerHTML = name;
      div.appendChild(li_name);
      const input = createInput(id);
      input.style.cssFloat = 'left';
      div.appendChild(input);
      const p = document.createElement('p');
      p.innerHTML = (`|___ id = ${li.id}`);
      div.appendChild(p);
      div.style.border = '2px solid rgb(304, 0, 318)';
      li.appendChild(div);
      //drag and drop//
      li.style.border = '2px solid rgb(104, 0, 18)';
      li.style.margin = '10px';
      li.style.padding = '10px';
      li.draggable = true;

      li.addEventListener('dragover', (evt) => dragoverHandler(evt));
      li.addEventListener('dragstart', (evt) => dragstartHandler(evt));
      return li;
    }
    createUl = (name) => {
      const id = new Date().valueOf();
      let ul = document.createElement('ul');
      ul.value = 'dropTarget';
      ul.id = `Ul${id}`;
      ul.title = `${name}`;
      //drag and drop//
      ul.style.border = '2px solid rgb(204, 0, 108)';
      ul.style.padding = '15px';
      ul.style.margin = '15px';
      //ul.draggable = true;
      ul.addEventListener('drop', (event) => dropHandler(event, ul.id));
      ul.addEventListener('dragover', (event) => dragoverHandler(event));
      ul.addEventListener('dragenter', (event) => dragenterHandler(event));
      ul.addEventListener('dragleave', (event) => event.target.style.backgroundColor = 'initial');
      return ul;
    }
    checkButtonsState = () => {
      const inputArr = document.querySelectorAll('input:checked');
      const close_button = document.querySelector('button[value = "CLOSE"]');
      const remove_button = document.querySelector('button[value = "REMOVE"]');
      if(!inputArr.length) {
        close_button.disabled = true;
        remove_button.disabled = true;
      } else {
        remove_button.disabled = false;
        for(inp of inputArr){
        let grandParent = inp.parentNode.parentNode;
          if(grandParent.childElementCount < 2){
            close_button.disabled = true;
            break;
          } else close_button.disabled = false;
        }
      }
    }
    addHandler = () => {
      const rootName = 'Tree';
      const input_arr = document.querySelectorAll('input:checked');
      const parent = event.target.parentNode;
      let ul = parent.nextSibling;

      if(!ul) {
        let ulBranch = createUl(rootName);
        ulBranch.appendChild(createBranch(ulBranch.title+0));
        parent.parentNode.appendChild(ulBranch);
      } else if(input_arr.length) {
          for(inp of input_arr) {
            let title = inp.parentNode.parentNode.title;
            if(!inp.parentNode.nextSibling){
              let ulBranch1 = createUl(title);
              ulBranch1.appendChild(createBranch(title+0))
              inp.parentNode.parentNode.appendChild(ulBranch1);
            } else {
              let subUl = inp.parentNode.nextSibling;
              const liTitle = subUl.lastChild.title;
              subUl.appendChild(createBranch(getName(liTitle)));
            }
          }
      } else {
        const nextTitle = ul.lastChild.title;
        ul.appendChild(createBranch(getName(nextTitle)));
      }
      checkButtonsState();
    }
    closeHandler = () => {
      const input_arr = document.querySelectorAll('input:checked');
      const close_button = document.querySelector('button[value = "CLOSE"]');
      if(close_button.innerHTML =='CLOSE'){
        close_button.innerHTML = 'OPEN';
        for (inp of input_arr){
          let ul = inp.parentNode.nextSibling;
          inp.nextSibling.style.visibility = 'hidden';
          ul.style.display = 'none';
        }
      } else {
        close_button.innerHTML = 'CLOSE';
        for (inp of input_arr){
          let ul = inp.parentNode.nextSibling;
          inp.nextSibling.style.visibility = 'visible';
          ul.style.display = 'block';
        }
      }
    }
    removeHandler = () => {
      const input_arr = document.querySelectorAll('input:checked');
      for(inp of input_arr) {
        let grandParent = inp.parentNode.parentNode;
        if(grandParent.parentNode.childElementCount > 1)
          grandParent.remove();
        else grandParent.parentNode.remove();
      }
      const close_button = document.querySelector('button[value = "CLOSE"]');
      close_button.innerHTML = 'CLOSE';
      checkButtonsState();
    }
    createHeader = () => {
      const header = document.createElement('div');
      const addButton = createAddButton();
      header.appendChild(addButton);
      const closeButton = createCloseButton();
      closeButton.disabled = true;
      header.appendChild(closeButton);
      const removeButton = createRemoveButoon();
      removeButton.disabled = true;
      header.appendChild(removeButton);
      header.style.margin = '30px';
      return header;
    }
    const container = document.getElementById('root');
    const header = createHeader();
    container.appendChild(header);
    /////////////////////////////////////////////////
    //drag and drop//
    const info = document.createElement('div');
    header.appendChild(info);
    info.style.display = 'flex';
    info.style.flexDirection = 'column';
    createInfo = (title) => {
      const input = document.createElement('INPUT');
      input.setAttribute('type', 'text');
      const p = document.createElement('p');
      p.innerHTML = title;
      p.style.margin = '5px';
      p.appendChild(input);
      input.style.margin = '1px';
      return input;
    }
    const input1 = createInfo(' coords');
    document.onmousemove = () => {
      input1.setAttribute("value",showCoords(event))
    }
    info.appendChild(input1.parentNode);
    const input2 = createInfo(' dragover');
    input2.style.width = '350px';
    info.appendChild(input2.parentNode);
    const input3 = createInfo(' drop');
    input3.style.display = 'flex';
    input3.style.width = '350px';
    info.appendChild(input3.parentNode);
    const input4 = createInfo(' drag start');
    input4.style.width = '350px';
    info.appendChild(input4.parentNode);
    const input5 = createInfo(' onMouseDown');
    input5.style.width = '350px'
    info.appendChild(input5.parentNode);
    const elem = document.onmousedown = () => {
      input5.setAttribute("value",`${event.target}, ${event.target.id}`);
      return event.target.id;
    }
    showCoords = (ev) => {
        var x = ev.clientX;
        var y = ev.clientY;
        var coords = "X: " + x + ", Y: " + y;
        return coords;
    }
    getNearElIndex = (ev) => {
      const children = ev.target.childNodes;
      const el = children[0];
      let index = children.length-1;
      const last_Y = ev.clientY;
      const moveItemIndex = ev.dataTransfer.getData("text");
      const moveItem =  document.getElementById(moveItemIndex);
      const initial_Y = moveItem.getBoundingClientRect().top;
      for(let i = 0; i < children.length; ++i){
        const target_Y = children[i].getBoundingClientRect().top;
        const dist = target_Y - last_Y;
        const direction = last_Y - initial_Y;
        if(dist > 0) {
          if(direction < 0)//moving up
          index = i;
          else index = --i; //moving down
          break;
        }
      }
      return index;
    }
    dropHandler = (ev, location) => {
      const parent = ev.target;
      let data = ev.dataTransfer.getData("text");
      let el = document.getElementById(data);

      console.log(location, el.parentNode.id, parent.id);
      // TODO check if listener works only first time
      // if (location !== el.parentNode.id) return null;

      const ul_arr = [];
      let children = parent.childNodes;
      const index = getNearElIndex(ev);
      let n = children.length;
      for (let i = 0; i < n; ++i){
        if(children[i] !== el)
        ul_arr.push(children[i]);
      }
      if(!el.nextSibling && !el.previousSibling
        && (el.parentNode.parentNode.parentNode.tagName === 'UL')
        && (parent !== el.parentNode))
        el.parentNode.remove();
      ul_arr.splice(index,0,el);
      while(parent.firstChild) parent.firstChild.remove();
      i = 0;
      while(ul_arr[i]) {
        console.log(ul_arr[i].firstChild.firstChild.innerHTML);
        // cosnt original = ul_arr[i].firstChild.firstChild.innerHTML
        ul_arr[i].firstChild.firstChild.innerHTML += ` -> ${i}`;
        parent.appendChild(ul_arr[i++]);
      }
      parent.style.backgroundColor = 'initial';
      input3.setAttribute("value",`${showCoords(ev)}, target=${ev.target.id}, data=${data}`);
      ev.preventDefault();
    };
    dragoverHandler = (ev) => {
      let d = '';
      if(ev.target.value === 'dropTarget') {
        ev.preventDefault();
        d = ev.target.value;
      } else d = 'no drop';
      input2.setAttribute("value",`${showCoords(ev)}, ${ev.target.id}, value:${d}`);
    };
    dragstartHandler = (ev) => {
      ev.dataTransfer.setData("text", ev.target.id);
      input4.setAttribute("value",`${showCoords(ev)}, ${ev.target.id}`);
    };
    dragenterHandler = (ev) => {
      if (ev.target.value === 'dropTarget')
      ev.target.style.backgroundColor = 'hsla(328, 92%, 88%, 0.72)';
    }
    </script>
  </body>
</html>
